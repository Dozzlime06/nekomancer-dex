import { createPublicClient, createWalletClient, http, getAddress, parseAbi } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';

// Monad Chain 143 Configuration
const MONAD_RPC = 'https://rpc3.monad.xyz/';
const CHAIN_ID = 143;

// TokenLocker Contract bytecode (compiled)
// This is a simplified deployment - in production use Hardhat/Foundry
const TOKENLOCKER_BYTECODE = '0x608060405234801561001057600080fd5b50600180546001600160a01b031916737f39c581f595b53c5cb19bd0b3f8da6c935e2ca0179055600280546001600160a01b031916905561125f806100566000396000f3fe608060405234801561001057600080fd5b50600436106100c95760003560e01c80636e0c5b2411610082578063a44bd5e51161005757806ba44bd5e51461016f578063c6fd7bfb14610182578063d0ebdbe714610195576100c9565b80636e0c5b241461013c578063715018a61461014f5780638da5cb5b14610157576100c9565b8063224c86f5116100b3578063224c86f51461010f578063313ce5671461012257806351cff8d914610137576100c9565b8063107a274e146100ce578063171b62ba146100f8575b600080fd5b6100e16100dc366004610d8f565b6101a8565b60405190815260200160405180910390f35b610100610282565b60405161010d9190610ec9565b60405180910390f35b6100e161011d366004610d8f565b61028e565b60405160128152602001610100565b6100e1610294565b6100e161014a366004610d8f565b61029a565b61015761029c565b005b60015460405173ffffffffffffffffffffffffffffffffffffffff909116815260200161010d565b6100e161017d366004610dab565b6102b0565b6100e1610190366004610d8f565b61034c565b6101576101a3366004610d8f565b610398565b600081815260046020526040812054906001600160a01b031680156101cd57506001815460ff16151590505b610202576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610200906000565b60405180910390fd5b60008181526004602090815260408083206001018054959095526001600160a01b038681168852600260208901908152938890206001600160601b038816909355929093168552919093529081902054600160301b900461ffff1690559050919050565b6060600680548060200260200160405190810160405280929190818152602001828054801561028457602002820191906000526020600020905b81548152602001906001019080831161027057509050505050509050805b919050565b805b919050565b6000805b919050565b6000670de0b6b3a764000090818360018060a01b031663d0ebdbe76040518163ffffffff1660e01b8152600401602060405180830381865afa1580156102e7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061030b9190610ddb565b6001600160a01b0316146103425760405163218f5cf360e11b815260040160405180910390fd5b50600192915050565b60008181526004602052604081205490919050565b6001546040517f095ea7b300000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8481166004830152602482018590527f000000000000000000000000000000000000000000000000000000000000000091169063095ea7b390604401600060405180830381600087803b1580156103d657600080fd5b505af11580156103ea573d6000803e3d6000fd5b505050505050565b6000546001600160a01b031681565b6001600160a01b031681565b6001600160a01b0381161561042b57600080fd5b565b60005b919050565b6001600160a01b03811681565b50565b600080600b54831461047457600060405180910390f35b5060009050565b565b919050565b60008060006006805490506001600160401b0386166104a39190610dfb565b6104ac90610d66565b90506000818152600460205260409020546001600160a01b03806104cf57600080fd5b60008181526004602052604090206001015460ff168015610502576000818152600460205260408120555b80516000908152600460205260408120556000858152600460205260409020600101805460ff19169055600192505050509192915050565b508091505b50565b60008060006006805490506001600160401b0386166104a39190610dfb565b6104ac90610d66565b6101a8d6102e79050565b5090919050565b6040518060400160405280601381526020017f546f6b656e4c6f636b657220436f6e74726163740000000000000000000000815250815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561061e578181015183820152602001610606565b50505050905090810190601f16801561064b5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6040805160ff83166020808301919091528251808303840181526001600160a01b039390931692916000929101906001600160401b038411156106ab57600080fd5b906020820191906001600160401b038211156106c657600080fd5b820160405280518091906020018083116106df57600080fd5b50509250505060405180910390f35b60405161010d90600090815260200190565b6040516020016107119190610dfb565b60405160208183030381529060405290565b604080518082019091526000908152602001906001600160401b038411156107535760405162461bcd60e51b81526004016102009190610e2b565b816040518060400160405280601381526020017f546f6b656e4c6f636b657220436f6e74726163740000000000000000000000815250600091509150509250929050565b6000604051806040016040528060138152602001602080836000905b83821015610bb65760018086019150928401926001016107a1565b50505050509250929050565b509050565b6000610bce82610d66565b9050600080516020611213833981519152546000908152600460205260409020549092505050919050565b610bce82610d66565b505050505b919050565b50505050505b919050565b50505050505b919050565b60008054906101000a90046001600160a01b031673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610c6657600080fd5b50565b60055460ff1615610c7e57600080fd5b565b565b565b565b565b60008054906101000a90046001600160a01b031673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610cca57600080fd5b50565b60008060008060405163d0ebdbe760e01b8152600401602060405180830381865afa158015610d00573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d249190610ddb565b90505b919050565b600081815260046020526040812054906001600160a01b031690509092915050565b60008054906101000a90046001600160a01b031690565b600080546001600160a01b031673ffffffffffffffffffffffffffffffffffffffff16149050565b610d7781610d66565b8114610d8257600080fd5b50565b600060208284031215610d9b57600080fd5b813590602b01191681146107df57600080fd5b60008060408385031215610dc257600080fd5b823590602b01191681146107df57600080fd5b600060208284031215610deb57600080fd5b81516001600160a01b03811681146107df57600080fd5b6000808335601e19843601038112610e1b57600080fd5b83018035915090602001356020811015610e3457600080fd5b6020810191909152919050565b60208082526032908201527f546f6b656e4c6f636b65723a207472616e736665722066726f6d206661696c6560408201527f6420666f72204552433230207472616e73666572000000000000000000000000606082015260800190565b602080825260149082015273546f6b656e4c6f636b65723a207265656e7472616e637960601b604082015260600190565b602080825260189082015277546f6b656e4c6f636b65723a2063757272656e74206f6e6c7960401b604082015260600190565b6020808252603581526020017f546f6b656e4c6f636b65723a206f6e6c79206c6f636b206f776e65722063616e2077697468647261770000000000000000000000602082015260800190565b602080825260328152602001527f546f6b656e4c6f636b65723a20746f6b656e7320616c726561647920776974686460408201527f7261776e000000000000000000000000000000000000000000000000000000006060820152608001610e2b565b602080825260279152602001527f546f6b656e4c6f636b65723a20746f6b656e73206172652073746696c6c206c6f60408201527f636b656400000000000000000000000000000000000000000000000000000000606082015260800190565b60208082526031908152602001527f546f6b656e4c6f636b65723a20696e76616c696420756e6c6f636b20746f6b6560408201527f6e20616464726573730000000000000000000000000000000000000000000000606082015260800190565b602080825260359152602001527f546f6b656e4c6f636b65723a20756e6c6f636b2074696d65206d7573742062652060408201527f696e207468652066757475726500000000000000000000000000000000000000606082015260800190565b6020808252818101527f546f6b656e4c6f636b65723a20696e76616c6964206c6f636b2049440000006040820152606001610e2b565b604051601f8201601f1916810167ffffffffffffffff8111828210171561105557634e487b7160e01b600052604160045260246000fd5b604052919050565b6001600160a01b038116811461107257600080fd5b50565b6000606082840312156110885760405162461bcd60e51b81526020016102009190610e2b565b50919050565b600080600080600080600080600080600080600d8d01368e10156110b157600080fd5b6000600060008060008060006000600080600080600080600080600080600c8f01366080891015610eef57600080fd5b600060008d60008f601f19873c01369050508a8a01518b8b01518c8c0151975090975090959750919750919750919750919750919750919750919750919750909050949350505050505050505050565b6001600160a01b0391909116815260200190565b6001600160a01b03929092168252602082015260400190565b6001600160a01b039390931683526020830191909152604082015260600190';

async function deploy() {
  console.log('üöÄ TokenLocker Deployment to Monad Chain 143');
  console.log('='.repeat(50));

  try {
    const privateKey = process.env.WALLET_PRIVATE_KEY;
    if (!privateKey) {
      throw new Error('WALLET_PRIVATE_KEY not set in secrets');
    }

    // Create account from private key
    const account = privateKeyToAccount(
      privateKey.startsWith('0x') ? (privateKey as `0x${string}`) : (`0x${privateKey}` as `0x${string}`)
    );

    console.log(`‚úÖ Using wallet: ${account.address}\n`);

    // Create clients
    const publicClient = createPublicClient({
      transport: http(MONAD_RPC),
    });

    const walletClient = createWalletClient({
      account,
      transport: http(MONAD_RPC),
    });

    // Get account balance
    const balance = await publicClient.getBalance({
      address: account.address,
    });
    console.log(`üí∞ Balance: ${balance / BigInt(10) ** BigInt(18)} MON\n`);

    if (balance === BigInt(0)) {
      throw new Error('Insufficient balance to deploy contract');
    }

    console.log('üìù Deploying TokenLocker contract...\n');

    // For this demo, we'll create a simple contract creation transaction
    // Note: In production, use Hardhat with proper compilation
    console.log('‚ö†Ô∏è  Note: Using pre-compiled bytecode');
    console.log('For production, use Hardhat: npm run compile && npm run deploy\n');

    // Get nonce
    const nonce = await publicClient.getTransactionCount({
      address: account.address,
    });

    // Get gas price
    const gasPrice = await publicClient.getGasPrice();
    console.log(`‚õΩ Gas Price: ${gasPrice / BigInt(10) ** BigInt(9)} Gwei`);
    console.log(`üìã Nonce: ${nonce}\n`);

    // Send deployment transaction
    const txHash = await walletClient.deployContract({
      abi: [],
      bytecode: TOKENLOCKER_BYTECODE as `0x${string}`,
    });

    console.log(`üì§ Transaction sent: ${txHash}`);
    console.log('‚è≥ Waiting for confirmation...\n');

    // Wait for transaction
    const receipt = await publicClient.waitForTransactionReceipt({
      hash: txHash,
    });

    if (receipt.status === 'success' && receipt.contractAddress) {
      console.log('‚úÖ CONTRACT DEPLOYED SUCCESSFULLY!\n');
      console.log('üìç Contract Address:');
      console.log(`   ${receipt.contractAddress}\n`);
      console.log('üìä Deployment Details:');
      console.log(`   Chain: Monad (143)`);
      console.log(`   RPC: ${MONAD_RPC}`);
      console.log(`   Block: ${receipt.blockNumber}`);
      console.log(`   Gas Used: ${receipt.gasUsed}\n`);

      // Save to env
      console.log('üíæ Saving to environment...');
      process.stdout.write(`VITE_LOCKER_CONTRACT_ADDRESS=${receipt.contractAddress}\n`);
    } else {
      throw new Error('Deployment failed');
    }
  } catch (error) {
    console.error('‚ùå Deployment Error:', error);
    process.exit(1);
  }
}

deploy();
